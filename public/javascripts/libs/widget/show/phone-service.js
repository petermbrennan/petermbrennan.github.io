"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}();$("body").on("runG5PhoneService",function(){});var PhoneNumberList=function(){function e(n,t){_classCallCheck(this,e),this.phoneList=[],this.bindGaEvent(),this.bindPreviewEvent(),this.previewMode=$(document).data("g5_preview_mode"),this.cpmCode=this.getOrStoreCpmCode(),this.locationUrns=[],this.callTrackingPromise=null,this.numbers={}}return _createClass(e,[{key:"addPhoneNumber",value:function(e){var n=this.phoneList.length<=0&&$(document).data("g5_ga_ready");this.phoneList.push(e),this.cpnsUrl=e.cpnsUrl,this.setExistingNumber(e,this.getNumberForUrn(e.locationUrn)),e.number||(this.setExistingNumber(e,this.getCachedNumber(e.locationUrn)),this.addLocationUrn(e.locationUrn),this.fetchOrWait()),n&&this.runCallTracking()}},{key:"setExistingNumber",value:function(e,n){n&&(e.number=n,$(e.scope).trigger("phoneNumbersReady"))}},{key:"getNumberForUrn",value:function(e){if(this.numbers)return this.numbers[e]}},{key:"addLocationUrn",value:function(e){$.inArray(e,this.locationUrns)<0&&this.locationUrns.push(e)}},{key:"runCallTracking",value:function(){this.fetch(),$(document).data("G5CallTrackingRun",!0)}},{key:"bindGaEvent",value:function(){var e=this;$(document).on("G5GaReady",function(n){e.runCallTracking()})}},{key:"bindPreviewEvent",value:function(){var e=this;$(document).on("G5PreviewReady",function(n){e.previewMode=$(document).data("g5_preview_mode"),e.showForPreview()})}},{key:"unbindGaEvent",value:function(){$(document).off("G5GaReady"),$(document).off("G5PreviewReady")}},{key:"fetchOrWait",value:function(){$(document).data("G5CallTrackingRun")&&!this.callTrackingPromise&&this.fetch()}},{key:"fetch",value:function(){var e=this;if(!this.previewMode)return this.callTrackingPromise||(this.callTrackingPromise=$.post(this.cpnsUrl,{phone_number:{screen_width:$(document).width(),cpm_code:this.cpmCode,location_urns:this.locationUrns,ga_client_id:this.getGaClientId()}},function(){},"json")),this.callTrackingPromise.then(function(n,t,i){$.each(n,function(n,t){e.locationUrns.splice(e.locationUrns.indexOf(n),1),e.numbers[n]=t,e.cacheNumber(t,n)}),e.phoneReady(),e.callTrackingPromise=null,e.locationUrns.length>0&&e.fetch()}),this.callTrackingPromise}},{key:"phoneReady",value:function(){var e=this;this.phoneList.forEach(function(n){n.number=e.numbers[n.locationUrn],n.number&&$(n.scope).trigger("phoneNumbersReady")})}},{key:"showForPreview",value:function(){this.phoneList.forEach(function(e){e.showNumber()})}},{key:"getOrStoreCpmCode",value:function(){var e=this.getParameterByName("cpm"),n=e||sessionStorage.getItem("cpm");return e&&sessionStorage.setItem("cpm",e),n}},{key:"getParameterByName",value:function(e){var n=null;e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),i=t.exec(location.search);return null!==i&&(n=decodeURIComponent(i[1].replace(/\+/g," "))),n}},{key:"getGaClientId",value:function(){var e;return"undefined"!=typeof ga&&ga(function(n){e=n.get("clientId")}),e||(e=sessionStorage.getItem("g5GaClientId-PhoneNumbers"),null===e&&(e="G5NoClientId"+Math.random().toString())),sessionStorage.setItem("g5GaClientId-PhoneNumbers",e),e}},{key:"cacheNumber",value:function(e,n){e.phone_number&&sessionStorage.setItem("g5PhoneNumber-"+n,JSON.stringify(e))}},{key:"getCachedNumber",value:function(e){return JSON.parse(sessionStorage.getItem("g5PhoneNumber-"+e))}}]),e}(),g5PhoneList=new PhoneNumberList,PhoneNumber=function(){function e(n,t){var i=this;if(_classCallCheck(this,e),this.configs=n,this.locationUrns=this.configs.locationUrns,!this.hasMultipleLocationUrns()){if(this.scope=t||"body",this.linkMode=this.configs.linkMode||"off",this.clientUrn=this.configs.clientUrn,this.cpnsUrl=this.configs.cpnsUrl,this.locationUrn=this.configs.locationUrn||"",this.updated=!1,!this.valid())throw"Invalid PhoneNumber config options";$(this.scope).bind("phoneNumbersReady",function(e){return i.update()}),g5PhoneList.addPhoneNumber(this),$("head").data("g5_preview_mode")&&this.showNumber()}}return _createClass(e,[{key:"hasMultipleLocationUrns",value:function(){var n=this;return!!this.locationUrns&&(delete this.configs.locationUrns,$.each(this.locationUrns,function(t,i){var o={};$.extend(!0,o,n.configs),o.locationUrn=i.urn,new e(o,i.scope)}),!0)}},{key:"valid",value:function(){return!!(this.cpnsUrl&&this.cpnsUrl.length&&this.clientUrn&&this.clientUrn.length&&this.locationUrn&&this.locationUrn.length)}},{key:"telTags",value:function n(e){var n=e.find(".p-tel");return n.length||(n=e.hasClass("p-tel")?e:[]),n}},{key:"showNumber",value:function(){var e=this.telTags($(this.scope));e.length>0&&e.css("visibility","visible")}},{key:"update",value:function(){if(!this.updated){this.updated=!0;var e=$(this.scope),n=this.telTags(e);if(n.length){var t=e.hasClass("number")?e:e.find(".number"),i=this.number.phone_number,o=this.getFormattedNumber(i);if(i.length&&o.length&&n.css("visibility","hidden"),o.length&&n.html(o),t.length)if("off"!==this.linkMode||this.isMobileWidth()){if(i.length){var r=this.getCountryCode()||"";t.attr("href","tel:"+r+i)}"no-click"!==this.linkMode||this.isMobileWidth()||(t.attr("href","").css({cursor:"default"}),t.on("click",function(e){return e.preventDefault(),e.stopPropagation(),!1}))}else t.contents().unwrap();n.css("visibility","visible")}}}},{key:"getCountryCode",value:function(e){return this.number.country_code_prefix}},{key:"getFormattedNumber",value:function(e){return e.length?e.replace(/(\d{3})(\d{3})(\d{4})/,"$1-$2-$3"):""}},{key:"isMobileWidth",value:function(){return!!($(document).width()<768)}},{key:"errorMessage",value:function(e){if("undefined"!==console&&e.length)return console.log(e)}}]),e}();