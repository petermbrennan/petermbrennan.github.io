"use strict";function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _get=function e(t,i,a){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,i);if(void 0===n){var r=Object.getPrototypeOf(t);return null===r?void 0:e(r,i,a)}if("value"in n)return n.value;var s=n.get;if(void 0!==s)return s.call(a)},_set=function t(e,i,a,n){var r=Object.getOwnPropertyDescriptor(e,i);if(void 0===r){var s=Object.getPrototypeOf(e);null!==s&&t(s,i,a,n)}else if("value"in r&&r.writable)r.value=a;else{var o=r.set;void 0!==o&&o.call(n,a)}return a},_slicedToArray=function(){function e(e,t){var i=[],a=!0,n=!1,r=void 0;try{for(var s,o=e[Symbol.iterator]();!(a=(s=o.next()).done)&&(i.push(s.value),!t||i.length!==t);a=!0);}catch(c){n=!0,r=c}finally{try{!a&&o["return"]&&o["return"]()}finally{if(n)throw r}}return i}return function(t,i){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}(),CloudinaryImageMixin=function(){function e(t,i){_classCallCheck(this,e),this.selectors=t,this.options={thumbnailWidth:100},this.options.hasMaxWidthMaxHeight=t.hasMaxWidthMaxHeight,this.onSuccessCallback=i,this.setupAddingImages(),this.renderThumbs(),this.hideShowRadio()}return _createClass(e,[{key:"setupAddingImages",value:function(){var e=this;$(".cloudinary-asset-btn").bind("click",function(t){e.definePreviousValues();var i=$(".cloudinary-asset-btn").data(),a=i.previousValues;$(window).trigger("add-assets-button-clicked",[t,a])}),$(window).on("dragDrop",function(){e.renderThumbs()}),$(window).on("assetSelected",function(t,i,a,n,r,s,o){if(e.setInputValues(o),i&&i.length){var c="#"+$(e.selectors.primary).closest(".tab-content").attr("id");$('a[href="'+c+'"]').click(),setTimeout(function(){var t=i.map(function(t){return e.createAssetURLs(t)});"bulk"===a?e.addBulkAssets(t):e.addSingleAsset(t[0],a),$(e.selectors.primary).change(),e.renderThumbs()},100)}})}},{key:"addBulkAssets",value:function(e){var t=this,i=this.selectors.primary,a=(e.map(function(e){return t.getThumbnailURLs(e)}),$(i).filter(function(){return!$(this).val()}));if($(i).each(function(t,i){var a=$(i).val();e.includes(a)&&e.splice(e.indexOf(a),1)}),a.length){for(var n=0;n<e.length;n++)$(a[n]).val(e[n]);$(window).trigger("imagesAddedToInputs"),this.renderThumbs()}$(this.selectors.primary).each(function(e,i){var a=$(i),n=a.val();t.getThumbnailURLs(n)})}},{key:"addSingleAsset",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!e.includes("c_crop");t&&$(t).length&&$(this.selectors.primary).closest("fieldset").find(t).length&&($(t).val(e),$(window).trigger("imagesAddedToInputs"),"none"!==this.croppingType()&&i&&setTimeout(function(){e.includes(".pdf")||$(t).closest("fieldset").find(".fa-crop").click()},1e3))}},{key:"createAssetURLs",value:function(e){var t=e.secureUrl,i=this.getMaxWidthMaxHeight(),a=_slicedToArray(i,2),n=a[0],r=a[1],s=Boolean(e.customCoordinates&&e.customCoordinates.length),o=this.croppingType();if("fixed"===o?t=t.replace("upload/","upload/q_auto,f_auto,c_fill,g_center,h_"+r+",w_"+n+"/"):s||"fixed"===o||(t=t.replace("upload/","upload/q_auto,f_auto,c_fill,g_center,h_"+e.height+",w_"+e.width+"/")),s){var c=_slicedToArray(e.customCoordinates,4),l=c[0],u=c[1],d=c[2],h=c[3];t=t.replace("upload/","upload/x_"+l+",y_"+u+",h_"+h+",w_"+d+",c_crop/")}return t.includes(".pdf")&&(t=this.cloudinaryURL+"g5/"+t.split("/g5/")[1]),t}},{key:"renderThumbs",value:function(e){var t=this,i=function(i,a){var n;n=e?$(e).closest("fieldset"):$(a).closest("fieldset");var r=e?$(e).val():n.find(t.selectors.primary).val(),s="http://placehold.it/100x100",o=r||s,c='<div class="fa fa-crop" aria-hidden="true"></div>';n.find(".img-thumbnail-preview").length||n.prepend("<div data-index='"+i+"' class='img-thumbnail-preview'>"+c+" <img src="+o+" class='image-thumb' /></div>"),o.includes(".pdf")&&(o=t.cloudinaryURL+"/f_auto/g5/"+o.split("/g5/")[1]),n.find(".img-thumbnail-preview img").attr("src",o)};$(e).each(i),$(this.selectors.primary).each(i)}},{key:"calculateAspectRatio",value:function(){var e=this.getMaxWidthMaxHeight(),t=_slicedToArray(e,2),i=t[0],a=t[1];return i/a}},{key:"croppingType",value:function(){return this.selectors.defaultCroppingType||$(this.selectors.croppingStyleSelector).val()||$(".form-field-cropping-style input:checked").val()}},{key:"calculateCroppingAspectRatio",value:function(){var e=this.calculateAspectRatio(),t=this.croppingType();return"fixed"===t?e:NaN}},{key:"getMaxWidthMaxHeight",value:function(){return this.options.hasMaxWidthMaxHeight?[parseInt($(this.selectors.maxWidth).val()),parseInt($(this.selectors.maxHeight).val())]:[1/0,1/0]}},{key:"getThumbnailURLs",value:function(e){var t=this.options,i=this.getMaxWidthMaxHeight(),a=_slicedToArray(i,2),n=a[0],r=a[1],s=Math.round(t.thumbnailWidth/this.calculateAspectRatio());return e.replace("h_"+r+",w_"+n,"h_"+s+",w_"+t.thumbnailWidth)}},{key:"definePreviousValues",value:function(){var e=this,t={croppingTypes:{},URLs:{},radios:{},checkedBoxes:{},notCheckedBoxes:{},texts:{},numbers:{},maxWidths:{},maxHeights:{}},i=Boolean($(".cloudinary-bulk-asset").length),a=function(e){var t={};if(e){var i="#"+e.attr("id"),a=e.val();t[i]=a}return t};$("fieldset").each(function(e,i){function n(e,i){var n=a(e);Object.assign(t[i],n)}var r=$(i),s=r.find("input:text").map(function(e,t){return $(t)}),o=r.find("input:radio:checked").map(function(e,t){return $(t)}),c=r.find('input[type="number"]').map(function(e,t){return $(t)}),l=r.find('input[type="checkbox"]:checked').map(function(e,t){return $(t)}),u=r.find('input[type="checkbox"]:not(:checked)').map(function(e,t){return $(t)});s.each(function(e,t){n($(t),"texts")}),o.each(function(e,t){n($(t),"radios")}),l.each(function(e,t){n($(t),"checkedBoxes")}),c.each(function(e,t){n($(t),"numbers")}),u.each(function(e,t){n($(t),"notCheckedBoxes")})}),$(".cloudinary-asset-btn").each(function(n,r){var s=(t.croppingTypes,t.maxWidths),o=t.maxHeights,c=t.URLs,l=$(r),u=l.closest("fieldset"),d=u.find('input[type="number"]').map(function(e,t){return $(t)}),h=_slicedToArray(d,2),p=h[0],f=h[1],g=u.find(".edit-image-url-field input:text"),v=u.find("input:radio:checked");if(v&&l.data("croppingType",v.val()),t.URLs=Object.assign(c,a(g)),i){var m=e.getMaxWidthMaxHeight(),y=_slicedToArray(m,2),b=y[0],x=y[1];l.data("maxWidth",b),l.data("maxHeight",x),e.selectors.maxWidth&&e.selectors.maxHeight&&(t.maxWidths[e.selectors.maxWidth]=b,t.maxHeights[e.selectors.maxHeight]=x)}else t.maxWidths=Object.assign(s,a(p)),t.maxHeights=Object.assign(o,a(f)),p&&f&&(l.data("maxWidth",p.val()),l.data("maxHeight",f.val()))}),this.setPreviousValues(t)}},{key:"hideShowRadio",value:function(){var e=this;$(this.selectors.primary).closest("fieldset").find("input:radio").change(function(){"fixed"==e.croppingType()?$(e.selectors.primary).closest("fieldset").find(".max-width-max-height").show():$(e.selectors.primary).closest("fieldset").find(".max-width-max-height").hide()}),$(this.selectors.primary).closest("fieldset").find("input:radio").change()}},{key:"setPreviousValues",value:function(e){$(".cloudinary-asset-btn").data("previousValues",e),$(".cloudinary-bulk-asset").data("previousValues",e)}},{key:"updateCheckbox",value:function(e,t){var i=$('input[type="checkbox"]:checked').map(function(e,t){return"#"+$(t).attr("id")}),a=$('input[type="checkbox"]:not(:checked)').map(function(e,t){return"#"+$(t).attr("id")});t&&[].concat(_toConsumableArray(a)).includes(e)?setTimeout(function(){$(e).click()},2e3):!t&&[].concat(_toConsumableArray(i)).includes(e)&&setTimeout(function(){$(e).click()},2e3)}},{key:"updatePreviousValue",value:function(e,t,i){switch(e){case"checkedBoxes":this.updateCheckbox(t,!0);break;case"notCheckedBoxes":this.updateCheckbox(t,!1);break;case"croppingTypes":case"radios":setTimeout(function(){$(t).click()},100);break;case"URLs":this.renderThumbs(t);case"maxHeights":case"maxWidths":case"texts":case"numbers":$(t).val(i)}}},{key:"setInputValues",value:function(e){for(var t in e)if(e.hasOwnProperty(t))for(var i in e[t])e[t].hasOwnProperty(i)&&this.updatePreviousValue(t,i,e[t][i]);this.renderThumbs()}}]),e}(),G5ImageEditor=function(e){function t(e,i){_classCallCheck(this,t);var a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return Object.assign(a,e),a.setUpImageEditor(),a.cloudinaryURL=_set(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"cloudinaryURL","https://res.cloudinary.com/g5-assets-cld/image/upload/",a),a}return _inherits(t,e),_createClass(t,[{key:"setUpImageEditor",value:function(){var e=this;$(".fa-crop").on("click",function(t){if(!$("#image-edit-preview-src").length){var i=$(t.currentTarget).closest("fieldset");e.closestFieldSet=i;var a=i.find(e.primary).val();e.hasErrors(a)||($(".modal-fullscreen").hide(),e.loadImageToEdit(a))}}),$(".cloudinary-remove-btn").click(function(t){var i=$(t.currentTarget).closest("fieldset");i.find(e.primary).val(""),e.renderThumbs(),e.onSuccessCallback()}),this.setupRefreshOnTyping()}},{key:"setupRefreshOnTyping",value:function(){var e,i=this,a=$(this.selectors.primary),n=function(){clearTimeout(e),e=setTimeout(function(){$("#image-edit-preview-src").length?$(".cancel-btn").click():(i.renderThumbs(),_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setInputValues",i).call(i))},1e3)};a.on("keyup",n),a.on("keydown",function(){clearTimeout(e)}),a.change(n),$(window).on("dragDrop",n)}},{key:"loadImageToEdit",value:function(e){this.previousImage=e,this.originalImage=e.slice(e.indexOf("/g5/"),e.length);var t=new FileReader,i=this.closestFieldSet;this.removeFieldsetAddCropHTML(i),this.canvas=this.createJcropCanvas(t,i);var a=this.cloudinaryURL+this.originalImage;this.loadImage(a).then(function(e){return t.readAsDataURL(e.response)})["catch"](function(e){return console.error("There was an error loading your image.",e)})}},{key:"loadImage",value:function(e){var t=new XMLHttpRequest;return new Promise(function(i,a){t.open("GET",e,!0),t.responseType="blob",t.onload=function(){try{200===this.status&&i(t)}catch(e){a(e)}},t.send()})}},{key:"hasErrors",value:function(e){return e.includes("cloudinary")?$(".fullscreen").length?"none"===this.croppingType()||!("fixed"!=this.croppingType()||!isNaN(this.calculateCroppingAspectRatio()))&&(alert("Fixed cropping requires width and height values. Please set width and height, or choose a different cropping mode."),!0):(alert("Please expand the modal to edit an image."),!0):(alert("You must upload an image to Cloudinary before you can edit."),!0)}},{key:"removeFieldsetAddCropHTML",value:function(e){e.children().hide(),e.prepend('<div class="image-edit-preview">\n                               <h5 class="loading-cloudinary-image">loading..</h5>\n                               <div class="source">\n                                <div id="image-edit-preview-src"></div>\n                               </div>\n                               <div style='+("fixed"!=this.croppingType()?"display:none;":"display:block;")+" class=\"static-coords-card-panel card-panel\">\n                               <h4 style='margin:auto!important' class='static-cloudinary-coords'></h4>\n                               <p class='go-back-text' >To change these dimensions, select cancel to go back to the edit modal</p>\n                               </div>\n                                <div class='edit-btns'>\n                                 <a class=\"cancel-btn waves-effect btn red enabled\"> Cancel</a>\n                                 <a class=\"save-btn disabled waves-effect btn blue\"> Save</a>\n                               </div>\n                             </div>")}},{key:"createJcropCanvas",value:function(e,t){var i=this,a=new Image,n=document.createElement("canvas");return e.onload=function(e){a.onload=function(){$(".loading-cloudinary-image").text(""),$(".edit-btns").css({display:"inline"}),i.setupButtonListeners(t),n.height=a.height,n.width=a.width;var e=n.getContext("2d");e.drawImage(a,0,0,n.width,n.height),$("#image-edit-preview-src").html('<img src="'+n.toDataURL()+'"/>');var r=function(e){return i.onChange(e)};if($("#image-edit-preview-src img").Jcrop({boxWidth:700,boxHeight:400,bgColor:"black",bgOpacity:.5,aspectRatio:i.calculateCroppingAspectRatio(),onChange:r}),"fixed"==i.croppingType()){var s=i.getMaxWidthMaxHeight(),o=_slicedToArray(s,2),c=o[0],l=o[1];$(".static-cloudinary-coords").text("Dimensions: "+c+" x "+l)}},a.src=e.target.result},n}},{key:"onChange",value:function(e){var t=e.h,i=e.w,a=e.x,n=e.x2,r=e.y,s=e.y2;$(".save-btn").removeClass("disabled").addClass("enabled");var o=[t,i,a,n,r,s].map(Math.round),c=_slicedToArray(o,6);t=c[0],i=c[1],a=c[2],n=c[3],r=c[4],s=c[5],"free"==this.croppingType()&&$(".jcrop-tracker").first().html("<div class='jcrop-coordinates'>"+i+" x "+t+"</div>");var l=this.cloudinaryURL;l+="x_"+a+",y_"+r+",h_"+t+",w_"+i+",c_crop/q_auto,f_auto,fl_lossy,c_fill,g_center,h_"+t+",w_"+i+this.originalImage,this.canvas.getContext("2d").drawImage($("#image-edit-preview-src img")[0],a,r,i,t,0,0,this.canvas.width,this.canvas.height),this.newImageURL=l}},{key:"replacefinalWidthHeight",value:function(e){var t=this.getMaxWidthMaxHeight(),i=_slicedToArray(t,2),a=i[0],n=i[1];e.includes(",c_fill")&&(e=e.replace(",c_fill",""));var r=e.split("q_auto"),s=r[1].replace(/h_\d*/,"h_"+n),o=s.replace(/w_\d*/,"w_"+a);return r[1]=o,r.join("q_auto")}},{key:"setupButtonListeners",value:function(e){var t=this,i=function(){$(".image-edit-preview").empty(),$(".image-edit-preview").remove(),$(".modal-fullscreen").show(),e.children().show(),t.previousImage=void 0,t.renderThumbs()};$(".cancel-btn").click(i),$(".save-btn").click(function(){t.newImageURL&&t.newImageURL!==t.cloudinaryURL&&("fixed"==t.croppingType()&&(t.newImageURL=t.replacefinalWidthHeight(t.newImageURL)),e.find(t.primary).val(t.newImageURL),t.onSuccessCallback()),i()})}}]),t}(CloudinaryImageMixin);